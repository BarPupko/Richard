<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>House & Garden - Cute Richard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Comic Sans MS', 'Arial', sans-serif;
            background: linear-gradient(to right, #8B4513 0%, #8B4513 50%, #90EE90 50%, #90EE90 100%);
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: rgba(86, 171, 47, 0.9);
            color: white;
            padding: 15px;
            text-align: center;
            position: relative;
            z-index: 10;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .header h1 {
            font-size: 1.8em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .score-board {
            display: flex;
            justify-content: space-around;
            margin-top: 10px;
            font-size: 1.1em;
        }

        .game-container {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        canvas {
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
        }

        .modal {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 100;
            background: rgba(255, 255, 255, 0.98);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            max-width: 500px;
            width: 90%;
        }

        .modal h2 {
            color: #56ab2f;
            margin-bottom: 20px;
            font-size: 2em;
        }

        .modal p {
            color: #666;
            margin-bottom: 20px;
            font-size: 1.1em;
        }

        .btn {
            background: linear-gradient(135deg, #56ab2f, #a8e063);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.3em;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
            font-family: 'Comic Sans MS', 'Arial', sans-serif;
            margin: 5px;
        }

        .btn:hover {
            transform: scale(1.05);
            box-shadow: 0 7px 20px rgba(0,0,0,0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #667eea, #764ba2);
        }

        .btn-small {
            padding: 10px 25px;
            font-size: 1.1em;
        }

        .controls-hint {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 15px 25px;
            border-radius: 15px;
            z-index: 5;
            font-size: 1.1em;
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.4em;
            }
            .score-board {
                font-size: 0.9em;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üè† Richard's House & Garden üå≥</h1>
        <div class="score-board">
            <div>Player: <span id="playerName">...</span></div>
            <div>Items: <span id="itemsCollected">0</span>/10 üì¶</div>
            <div>Time: <span id="timer">0</span>s ‚è±Ô∏è</div>
        </div>
    </div>

    <div class="game-container">
        <canvas id="gameCanvas"></canvas>

        <!-- Start Screen -->
        <div class="modal" id="startScreen">
            <h2>üê∂ Help Richard Fetch Items! üì¶</h2>
            <p>Move Richard between the house and garden!<br><br>
            üè† Grab items from inside the house<br>
            üö™ Wait for the door to open<br>
            üå≥ Bring them to the garden area<br><br>
            <strong>Controls:</strong> Click/Tap or Arrow Keys/WASD</p>
            <button class="btn" onclick="startGame()">Start Game!</button>
            <button class="btn btn-secondary btn-small" onclick="goBack()">Back to Menu</button>
        </div>

        <!-- Game Over Modal -->
        <div class="modal" id="gameOverModal">
            <h2>üéâ Great Job! üéâ</h2>
            <p style="font-size: 1.3em; color: #333;">
                You collected all items in <span id="finalTime">0</span> seconds! üèÜ<br>
                <span id="highScoreMessage"></span>
            </p>

            <button class="btn" onclick="restartGame()">Play Again</button>
            <button class="btn btn-secondary btn-small" onclick="goBack()">Back to Menu</button>
        </div>

        <div class="controls-hint" id="controlsHint">
            Click/Tap to move Richard or use Arrow Keys ‚å®Ô∏è
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, update, get } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDYrFZbFzAyoBBXJoX83Wq_CumP6NYie64",
            authDomain: "richardgame-67766.firebaseapp.com",
            databaseURL: "https://richardgame-67766-default-rtdb.firebaseio.com",
            projectId: "richardgame-67766",
            storageBucket: "richardgame-67766.firebasestorage.app",
            messagingSenderId: "886284486792",
            appId: "1:886284486792:web:f797fe51368861eab8f73d",
            measurementId: "G-D5K95ZN5GC"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        window.firebaseDB = database;
        window.firebaseRef = ref;
        window.firebaseUpdate = update;
        window.firebaseGet = get;

        initializeUser();
    </script>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight - document.querySelector('.header').offsetHeight;
        }
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        // User management
        let userId = null;
        let userName = 'Player';
        let userHighScore = Infinity;

        function initializeUser() {
            const userDataStr = sessionStorage.getItem('richardUserData');
            if (userDataStr) {
                try {
                    const userData = JSON.parse(userDataStr);
                    userId = userData.userId;
                    userName = userData.userName || 'Player';
                    userHighScore = userData.highScores?.houseGarden || Infinity;
                    document.getElementById('playerName').textContent = userName;
                } catch (error) {
                    console.error('Error parsing user data:', error);
                }
            } else {
                alert('Please start from the main menu!');
                window.location.href = 'richard-index.html';
                return;
            }

            document.getElementById('startScreen').style.display = 'block';
        }

        async function saveHighScore(timeTaken) {
            if (timeTaken < userHighScore) {
                userHighScore = timeTaken;

                const userDataStr = sessionStorage.getItem('richardUserData');
                if (userDataStr) {
                    const userData = JSON.parse(userDataStr);
                    userData.highScores = userData.highScores || {};
                    userData.highScores.houseGarden = timeTaken;
                    sessionStorage.setItem('richardUserData', JSON.stringify(userData));
                }

                const localData = JSON.parse(localStorage.getItem('richardUserProfile') || '{}');
                localData.highScores = localData.highScores || {};
                localData.highScores.houseGarden = timeTaken;
                localStorage.setItem('richardUserProfile', JSON.stringify(localData));

                try {
                    const userRef = window.firebaseRef(window.firebaseDB, 'users/' + userId + '/highScores');
                    await window.firebaseUpdate(userRef, {
                        houseGarden: timeTaken,
                        lastPlayed: Date.now()
                    });
                } catch (error) {
                    console.warn('Could not sync high score with Firebase:', error);
                }

                return true;
            }
            return false;
        }

        // Game variables
        let gameRunning = false;
        let itemsCollected = 0;
        let totalItems = 10;
        let gameTimer = 0;
        let timerInterval = null;

        // Door state
        let doorOpen = false;
        let doorTimer = 0;
        let nextDoorChange = 2000; // milliseconds

        // Richard position
        let richard = {
            x: canvas.width * 0.75, // Start in garden
            y: canvas.height / 2,
            targetX: canvas.width * 0.75,
            targetY: canvas.height / 2,
            width: 60,
            height: 45,
            speed: 0.15,
            carryingItem: false
        };

        // Items in house
        let houseItems = [];

        // Generate random items in house
        function generateItems() {
            houseItems = [];
            const houseLeft = 50;
            const houseRight = canvas.width / 2 - 100;
            const houseTop = 50;
            const houseBottom = canvas.height - 50;

            for (let i = 0; i < totalItems; i++) {
                houseItems.push({
                    x: houseLeft + Math.random() * (houseRight - houseLeft),
                    y: houseTop + Math.random() * (houseBottom - houseTop),
                    collected: false
                });
            }
        }

        // Draw Richard
        function drawRichard(x, y) {
            ctx.save();

            // Body
            ctx.fillStyle = '#d4a373';
            ctx.beginPath();
            ctx.ellipse(x, y, 30, 18, 0, 0, Math.PI * 2);
            ctx.fill();

            // White belly
            ctx.fillStyle = '#ffffff';
            ctx.beginPath();
            ctx.ellipse(x, y + 3, 18, 11, 0, 0, Math.PI * 2);
            ctx.fill();

            // Head
            ctx.fillStyle = '#d4a373';
            ctx.beginPath();
            ctx.ellipse(x - 18, y - 7, 15, 13, 0, 0, Math.PI * 2);
            ctx.fill();

            // White face
            ctx.fillStyle = '#ffffff';
            ctx.beginPath();
            ctx.ellipse(x - 18, y - 6, 9, 7, 0, 0, Math.PI * 2);
            ctx.fill();

            // Eyes
            ctx.fillStyle = '#000000';
            ctx.beginPath();
            ctx.arc(x - 22, y - 9, 2, 0, Math.PI * 2);
            ctx.arc(x - 14, y - 9, 2, 0, Math.PI * 2);
            ctx.fill();

            // Nose
            ctx.fillStyle = '#000000';
            ctx.beginPath();
            ctx.arc(x - 18, y - 4, 3, 0, Math.PI * 2);
            ctx.fill();

            // Tail
            ctx.strokeStyle = '#d4a373';
            ctx.lineWidth = 5;
            ctx.beginPath();
            ctx.moveTo(x + 30, y);
            ctx.quadraticCurveTo(x + 37, y - 7, x + 33, y - 15);
            ctx.stroke();

            // If carrying item, draw box above
            if (richard.carryingItem) {
                ctx.fillStyle = '#CD853F';
                ctx.fillRect(x - 10, y - 35, 20, 20);
                ctx.strokeStyle = '#8B4513';
                ctx.lineWidth = 2;
                ctx.strokeRect(x - 10, y - 35, 20, 20);
            }

            ctx.restore();
        }

        // Draw item (box)
        function drawItem(x, y) {
            ctx.fillStyle = '#CD853F';
            ctx.fillRect(x - 10, y - 10, 20, 20);
            ctx.strokeStyle = '#8B4513';
            ctx.lineWidth = 2;
            ctx.strokeRect(x - 10, y - 10, 20, 20);
        }

        // Draw door
        function drawDoor() {
            const doorX = canvas.width / 2 - 40;
            const doorY = canvas.height / 2 - 60;
            const doorWidth = 80;
            const doorHeight = 120;

            // Door frame
            ctx.fillStyle = '#654321';
            ctx.fillRect(doorX, doorY, doorWidth, doorHeight);

            if (doorOpen) {
                // Open door - show opening
                ctx.fillStyle = '#000000';
                ctx.fillRect(doorX + 10, doorY + 10, doorWidth - 20, doorHeight - 20);
                ctx.fillStyle = '#90EE90';
                ctx.font = '20px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('OPEN', doorX + doorWidth / 2, doorY + doorHeight / 2);
            } else {
                // Closed door
                ctx.fillStyle = '#8B4513';
                ctx.fillRect(doorX + 5, doorY + 5, doorWidth - 10, doorHeight - 10);
                // Door knob
                ctx.fillStyle = '#FFD700';
                ctx.beginPath();
                ctx.arc(doorX + doorWidth - 20, doorY + doorHeight / 2, 5, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        let lastFrameTime = Date.now();

        function update() {
            if (!gameRunning) return;

            const currentTime = Date.now();
            const deltaTime = currentTime - lastFrameTime;
            lastFrameTime = currentTime;

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Draw house side (left half - brown)
            ctx.fillStyle = '#D2B48C';
            ctx.fillRect(0, 0, canvas.width / 2, canvas.height);

            // Draw garden side (right half - green)
            ctx.fillStyle = '#7cb342';
            ctx.fillRect(canvas.width / 2, 0, canvas.width / 2, canvas.height);

            // Draw dividing line
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(canvas.width / 2, 0);
            ctx.lineTo(canvas.width / 2, canvas.height);
            ctx.stroke();

            // Update door timer
            doorTimer += deltaTime;
            if (doorTimer >= nextDoorChange) {
                doorOpen = !doorOpen;
                doorTimer = 0;
                nextDoorChange = 1000 + Math.random() * 2000; // 1-3 seconds
            }

            // Draw door
            drawDoor();

            // Draw uncollected items
            houseItems.forEach(item => {
                if (!item.collected) {
                    drawItem(item.x, item.y);
                }
            });

            // Move Richard towards target
            const dx = richard.targetX - richard.x;
            const dy = richard.targetY - richard.y;
            const distance = Math.sqrt(dx * dx + dy * dy);

            if (distance > 2) {
                richard.x += dx * richard.speed;
                richard.y += dy * richard.speed;

                // Check if trying to cross door when closed
                const doorCenterX = canvas.width / 2;
                const prevSide = richard.x < doorCenterX ? 'left' : 'right';
                const newSide = richard.x < doorCenterX ? 'left' : 'right';

                if (prevSide !== newSide && !doorOpen) {
                    // Block movement through closed door
                    richard.x = doorCenterX + (prevSide === 'left' ? -5 : 5);
                }
            }

            // Draw Richard
            drawRichard(richard.x, richard.y);

            // Check item pickup (only in house, not carrying)
            if (!richard.carryingItem && richard.x < canvas.width / 2) {
                houseItems.forEach(item => {
                    if (!item.collected) {
                        const dist = Math.sqrt(
                            Math.pow(richard.x - item.x, 2) +
                            Math.pow(richard.y - item.y, 2)
                        );
                        if (dist < 30) {
                            item.collected = true;
                            richard.carryingItem = true;
                        }
                    }
                });
            }

            // Check item delivery (in garden with item)
            if (richard.carryingItem && richard.x > canvas.width / 2 + 50) {
                richard.carryingItem = false;
                itemsCollected++;
                document.getElementById('itemsCollected').textContent = itemsCollected;

                if (itemsCollected >= totalItems) {
                    endGame();
                    return;
                }
            }

            requestAnimationFrame(update);
        }

        // Input handling
        canvas.addEventListener('click', (e) => {
            if (!gameRunning) return;

            const rect = canvas.getBoundingClientRect();
            richard.targetX = e.clientX - rect.left;
            richard.targetY = e.clientY - rect.top;
        });

        canvas.addEventListener('touchstart', (e) => {
            if (!gameRunning) return;
            e.preventDefault();

            const rect = canvas.getBoundingClientRect();
            richard.targetX = e.touches[0].clientX - rect.left;
            richard.targetY = e.touches[0].clientY - rect.top;
        });

        // Keyboard controls
        let keys = {};
        document.addEventListener('keydown', (e) => {
            keys[e.key] = true;
        });

        document.addEventListener('keyup', (e) => {
            keys[e.key] = false;
        });

        function handleKeyboard() {
            if (!gameRunning) return;

            const speed = 5;
            if (keys['ArrowUp'] || keys['w'] || keys['W']) richard.targetY = richard.y - speed;
            if (keys['ArrowDown'] || keys['s'] || keys['S']) richard.targetY = richard.y + speed;
            if (keys['ArrowLeft'] || keys['a'] || keys['A']) richard.targetX = richard.x - speed;
            if (keys['ArrowRight'] || keys['d'] || keys['D']) richard.targetX = richard.x + speed;

            // Keep within bounds
            richard.targetX = Math.max(30, Math.min(canvas.width - 30, richard.targetX));
            richard.targetY = Math.max(30, Math.min(canvas.height - 30, richard.targetY));

            requestAnimationFrame(handleKeyboard);
        }

        // Timer
        function startTimer() {
            gameTimer = 0;
            document.getElementById('timer').textContent = gameTimer;

            timerInterval = setInterval(() => {
                gameTimer++;
                document.getElementById('timer').textContent = gameTimer;
            }, 1000);
        }

        function stopTimer() {
            clearInterval(timerInterval);
        }

        // Game flow
        function startGame() {
            document.getElementById('startScreen').style.display = 'none';
            document.getElementById('controlsHint').style.display = 'block';

            gameRunning = true;
            itemsCollected = 0;
            document.getElementById('itemsCollected').textContent = itemsCollected;

            richard.x = canvas.width * 0.75;
            richard.y = canvas.height / 2;
            richard.targetX = richard.x;
            richard.targetY = richard.y;
            richard.carryingItem = false;

            doorOpen = false;
            doorTimer = 0;
            nextDoorChange = 2000;
            lastFrameTime = Date.now();

            generateItems();
            startTimer();
            update();
            handleKeyboard();

            setTimeout(() => {
                document.getElementById('controlsHint').style.display = 'none';
            }, 5000);
        }

        async function endGame() {
            gameRunning = false;
            stopTimer();

            const finalTime = gameTimer;
            document.getElementById('finalTime').textContent = finalTime;

            const isNewHighScore = await saveHighScore(finalTime);

            const highScoreMsg = document.getElementById('highScoreMessage');
            if (isNewHighScore) {
                highScoreMsg.textContent = 'üéä NEW PERSONAL BEST! üéä';
                highScoreMsg.style.color = '#ff6347';
                highScoreMsg.style.fontWeight = 'bold';
            } else if (userHighScore < Infinity) {
                highScoreMsg.textContent = `Your best time: ${userHighScore}s`;
                highScoreMsg.style.color = '#666';
                highScoreMsg.style.fontWeight = 'normal';
            } else {
                highScoreMsg.textContent = '';
            }

            document.getElementById('gameOverModal').style.display = 'block';
        }

        function restartGame() {
            document.getElementById('gameOverModal').style.display = 'none';
            startGame();
        }

        function goBack() {
            window.location.href = 'richard-index.html';
        }
    </script>
</body>
</html>
